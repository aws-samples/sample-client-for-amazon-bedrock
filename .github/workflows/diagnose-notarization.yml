name: "diagnose-notarization"

on:
  workflow_dispatch:

jobs:
  diagnose-apple-config:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Diagnose Apple ID Configuration
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "ğŸ” Apple ID å…¬è¯é…ç½®è¯Šæ–­"
          echo "=========================="
          
          # æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
          if [ -z "$APPLE_ID" ] || [ -z "$APPLE_PASSWORD" ] || [ -z "$APPLE_TEAM_ID" ]; then
            echo "âŒ ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡"
            echo "APPLE_ID: ${APPLE_ID:+è®¾ç½®} ${APPLE_ID:-æœªè®¾ç½®}"
            echo "APPLE_PASSWORD: ${APPLE_PASSWORD:+è®¾ç½®} ${APPLE_PASSWORD:-æœªè®¾ç½®}"
            echo "APPLE_TEAM_ID: ${APPLE_TEAM_ID:+è®¾ç½®} ${APPLE_TEAM_ID:-æœªè®¾ç½®}"
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡éƒ½å·²è®¾ç½®"
          
          # æ£€æŸ¥ Apple ID æ ¼å¼
          if [[ "$APPLE_ID" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
            echo "âœ… Apple ID æ ¼å¼æ­£ç¡®: $APPLE_ID"
          else
            echo "âŒ Apple ID æ ¼å¼ä¸æ­£ç¡®: $APPLE_ID"
          fi
          
          # æ£€æŸ¥ Team ID æ ¼å¼
          if [[ "$APPLE_TEAM_ID" =~ ^[A-Z0-9]{10}$ ]]; then
            echo "âœ… Team ID æ ¼å¼æ­£ç¡®: $APPLE_TEAM_ID"
          else
            echo "âŒ Team ID æ ¼å¼ä¸æ­£ç¡®: $APPLE_TEAM_ID (é•¿åº¦: ${#APPLE_TEAM_ID})"
          fi
          
          # æ£€æŸ¥ App-Specific Password æ ¼å¼
          echo "Apple Password é•¿åº¦: ${#APPLE_PASSWORD}"
          if [[ ${#APPLE_PASSWORD} -eq 16 ]]; then
            echo "âœ… Apple Password é•¿åº¦æ­£ç¡®"
          else
            echo "âŒ Apple Password é•¿åº¦ä¸æ­£ç¡® (åº”è¯¥æ˜¯ 16)"
          fi

      - name: Test Apple Notarization Service Connection
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "ğŸŒ æµ‹è¯• Apple å…¬è¯æœåŠ¡è¿æ¥..."
          
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•æ–‡ä»¶
          echo "test content" > test_file.txt
          zip test_file.zip test_file.txt
          
          # å°è¯•ä½¿ç”¨ notarytool éªŒè¯é…ç½®
          echo "éªŒè¯ Apple ID é…ç½®..."
          
          # é¦–å…ˆå°è¯•å­˜å‚¨å‡­æ®
          if xcrun notarytool store-credentials "github-test" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$APPLE_TEAM_ID"; then
            echo "âœ… Apple ID å‡­æ®éªŒè¯æˆåŠŸ"
            
            # å°è¯•è·å–æäº¤å†å²ï¼ˆè¿™ä¼šéªŒè¯è¿æ¥ï¼‰
            echo "æµ‹è¯•å…¬è¯æœåŠ¡è¿æ¥..."
            if xcrun notarytool history --keychain-profile "github-test" --output-format json; then
              echo "âœ… å…¬è¯æœåŠ¡è¿æ¥æˆåŠŸ"
            else
              echo "âŒ å…¬è¯æœåŠ¡è¿æ¥å¤±è´¥"
            fi
            
            # æ¸…ç†æµ‹è¯•å‡­æ®
            xcrun notarytool delete-credentials "github-test" || true
          else
            echo "âŒ Apple ID å‡­æ®éªŒè¯å¤±è´¥"
            echo "å¯èƒ½çš„åŸå› :"
            echo "1. Apple ID æˆ– App-Specific Password ä¸æ­£ç¡®"
            echo "2. Apple ID æœªå¯ç”¨åŒé‡è®¤è¯"
            echo "3. Team ID ä¸æ­£ç¡®"
            echo "4. App-Specific Password å·²è¿‡æœŸæˆ–è¢«æ’¤é”€"
          fi
          
          # æ¸…ç†æµ‹è¯•æ–‡ä»¶
          rm -f test_file.txt test_file.zip

      - name: Check Certificate and Notarization Compatibility
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          echo "ğŸ” æ£€æŸ¥è¯ä¹¦å’Œå…¬è¯å…¼å®¹æ€§..."
          
          # å¯¼å…¥è¯ä¹¦
          echo "$APPLE_CERTIFICATE" | base64 -d > certificate.p12
          
          # åˆ›å»ºä¸´æ—¶ keychain
          security create-keychain -p "temp123" temp.keychain
          security default-keychain -s temp.keychain
          security unlock-keychain -p "temp123" temp.keychain
          security set-keychain-settings -t 3600 -u temp.keychain
          
          # å¯¼å…¥è¯ä¹¦
          if security import certificate.p12 -k temp.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign; then
            echo "âœ… è¯ä¹¦å¯¼å…¥æˆåŠŸ"
            
            # æ£€æŸ¥è¯ä¹¦ç±»å‹
            echo "è¯ä¹¦è¯¦ç»†ä¿¡æ¯:"
            security find-identity -v -p codesigning temp.keychain
            
            # æ£€æŸ¥è¯ä¹¦æ˜¯å¦ä¸º Developer ID Application
            if security find-identity -v -p codesigning temp.keychain | grep -q "Developer ID Application"; then
              echo "âœ… è¯ä¹¦ç±»å‹æ­£ç¡®: Developer ID Application"
              echo "âœ… æ­¤ç±»å‹è¯ä¹¦æ”¯æŒå…¬è¯"
            else
              echo "âŒ è¯ä¹¦ç±»å‹å¯èƒ½ä¸æ”¯æŒå…¬è¯"
              echo "éœ€è¦ 'Developer ID Application' è¯ä¹¦è¿›è¡Œå…¬è¯"
            fi
          else
            echo "âŒ è¯ä¹¦å¯¼å…¥å¤±è´¥"
          fi
          
          # æ¸…ç†
          security delete-keychain temp.keychain || true
          rm -f certificate.p12

      - name: Provide Recommendations
        run: |
          echo ""
          echo "ğŸ“‹ è¯Šæ–­å®Œæˆ - å»ºè®®çš„ä¿®å¤æ­¥éª¤:"
          echo "================================"
          echo ""
          echo "å¦‚æœ Apple ID é…ç½®å¤±è´¥:"
          echo "1. è®¿é—® https://appleid.apple.com"
          echo "2. ç¡®ä¿å¯ç”¨åŒé‡è®¤è¯"
          echo "3. ç”Ÿæˆæ–°çš„ App-Specific Password:"
          echo "   - è¿›å…¥ 'Sign-In and Security'"
          echo "   - ç‚¹å‡» 'App-Specific Passwords'"
          echo "   - ç”Ÿæˆæ–°å¯†ç å¹¶å‘½åä¸º 'GitHub Actions'"
          echo "4. æ›´æ–° GitHub Secrets:"
          echo "   - APPLE_PASSWORD: ä½¿ç”¨æ–°çš„ App-Specific Password"
          echo ""
          echo "å¦‚æœè¯ä¹¦é—®é¢˜:"
          echo "1. ç¡®ä¿ä½¿ç”¨ 'Developer ID Application' è¯ä¹¦"
          echo "2. è¯ä¹¦å¿…é¡»åœ¨æœ‰æ•ˆæœŸå†…"
          echo "3. è¯ä¹¦å¿…é¡»ä¸ Team ID åŒ¹é…"
          echo ""
          echo "å¦‚æœä»æœ‰é—®é¢˜:"
          echo "1. æ£€æŸ¥ Apple Developer è´¦æˆ·çŠ¶æ€"
          echo "2. ç¡®è®¤è´¦æˆ·æœ‰å…¬è¯æƒé™"
          echo "3. è€ƒè™‘é‡æ–°ç”Ÿæˆè¯ä¹¦å’Œ App-Specific Password"
