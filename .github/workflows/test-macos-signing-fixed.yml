name: "test-macos-signing-fixed"

on: 
  workflow_dispatch: # Manual trigger only

jobs:
  test-macos-signing:
    permissions:
      contents: write
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Install frontend dependencies
        run: yarn install

      - name: Debug Certificate Configuration
        run: |
          echo "ğŸ” è°ƒè¯•è¯ä¹¦é…ç½®..."
          echo "APPLE_CERTIFICATE é•¿åº¦: ${#APPLE_CERTIFICATE}"
          echo "APPLE_CERTIFICATE_PASSWORD é•¿åº¦: ${#APPLE_CERTIFICATE_PASSWORD}"
          echo "APPLE_SIGNING_IDENTITY: '$APPLE_SIGNING_IDENTITY'"
          
          # æ£€æŸ¥è¯ä¹¦æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ base64
          if echo "$APPLE_CERTIFICATE" | base64 -d > /tmp/test_cert.p12 2>/dev/null; then
            echo "âœ“ è¯ä¹¦ base64 è§£ç æˆåŠŸ"
            ls -la /tmp/test_cert.p12
            
            # æµ‹è¯•ä¸åŒçš„å¯†ç 
            echo "æµ‹è¯•ç©ºå¯†ç ..."
            if openssl pkcs12 -info -in /tmp/test_cert.p12 -password "pass:" -noout 2>/dev/null; then
              echo "âœ“ ç©ºå¯†ç éªŒè¯æˆåŠŸ"
              CERT_PASSWORD=""
            else
              echo "âœ— ç©ºå¯†ç éªŒè¯å¤±è´¥"
              echo "æµ‹è¯•è®¾ç½®çš„å¯†ç ..."
              if openssl pkcs12 -info -in /tmp/test_cert.p12 -password "pass:$APPLE_CERTIFICATE_PASSWORD" -noout 2>/dev/null; then
                echo "âœ“ è®¾ç½®çš„å¯†ç éªŒè¯æˆåŠŸ"
                CERT_PASSWORD="$APPLE_CERTIFICATE_PASSWORD"
              else
                echo "âœ— è®¾ç½®çš„å¯†ç éªŒè¯å¤±è´¥"
              fi
            fi
            
            echo "æœ€ç»ˆä½¿ç”¨å¯†ç : '$CERT_PASSWORD'"
          else
            echo "âœ— è¯ä¹¦ base64 è§£ç å¤±è´¥"
            exit 1
          fi
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}

      - name: Build macOS app with signing (ARM64 only)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENABLE_CODE_SIGNING: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          tagName: ""
          releaseName: ""
          releaseBody: ""
          releaseDraft: false
          prerelease: false
          args: --target aarch64-apple-darwin

      - name: Verify build output
        run: |
          echo "ğŸ” æ£€æŸ¥æ„å»ºè¾“å‡º..."
          find src-tauri/target -name "*.app" -o -name "*.dmg" | head -10
          
          # éªŒè¯ç­¾å
          APP_PATH=$(find src-tauri/target -name "*.app" | head -1)
          if [[ -n "$APP_PATH" ]]; then
            echo "éªŒè¯åº”ç”¨ç­¾å: $APP_PATH"
            codesign -dv --verbose=4 "$APP_PATH" || echo "ç­¾åéªŒè¯å¤±è´¥"
            
            echo "æ£€æŸ¥ç­¾åèº«ä»½:"
            codesign -dv "$APP_PATH" 2>&1 | grep "Authority=" || echo "æ— æ³•è·å–ç­¾åèº«ä»½"
          fi

      - name: Upload signed app
        uses: actions/upload-artifact@v4
        with:
          name: signed-macos-app-arm64-fixed
          path: |
            src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app
            src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
          retention-days: 7
          if-no-files-found: warn
