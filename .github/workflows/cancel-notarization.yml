name: "cancel-notarization"

on:
  workflow_dispatch:
    inputs:
      cancel_all_in_progress:
        description: 'Cancel all In Progress submissions'
        required: false
        default: 'true'
        type: boolean
      specific_submission_id:
        description: 'Specific submission ID to cancel (optional)'
        required: false
        type: string

jobs:
  cancel:
    runs-on: macos-latest
    steps:
      - name: Cancel Notarization Submissions
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          CANCEL_ALL: ${{ github.event.inputs.cancel_all_in_progress }}
          SPECIFIC_ID: ${{ github.event.inputs.specific_submission_id }}
        run: |
          echo "ğŸš« å¼€å§‹æ’¤é”€å…¬è¯æäº¤ - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=================================="
          
          # å­˜å‚¨å‡­æ®
          xcrun notarytool store-credentials "cancel" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$APPLE_TEAM_ID"
          
          echo "ğŸ“‹ è·å–å½“å‰å…¬è¯å†å²..."
          xcrun notarytool history --keychain-profile "cancel" --output-format json > history.json
          
          # æ˜¾ç¤ºå½“å‰çŠ¶æ€
          echo "å½“å‰å…¬è¯æäº¤çŠ¶æ€:"
          cat history.json | jq -r '.history[0:10][] | "ğŸ”¸ ID: \(.id) | çŠ¶æ€: \(.status) | åˆ›å»ºæ—¶é—´: \(.createdDate) | åç§°: \(.name)"'
          
          if [ "$CANCEL_ALL" = "true" ]; then
            echo ""
            echo "ğŸš« æ’¤é”€æ‰€æœ‰ 'In Progress' çŠ¶æ€çš„æäº¤..."
            
            # è·å–æ‰€æœ‰ In Progress çš„æäº¤ID
            IN_PROGRESS_IDS=$(cat history.json | jq -r '.history[] | select(.status == "In Progress") | .id')
            
            if [ -z "$IN_PROGRESS_IDS" ]; then
              echo "âœ… æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ’¤é”€çš„æäº¤"
            else
              echo "æ‰¾åˆ°ä»¥ä¸‹éœ€è¦æ’¤é”€çš„æäº¤:"
              echo "$IN_PROGRESS_IDS"
              echo ""
              
              # é€ä¸ªæ’¤é”€
              echo "$IN_PROGRESS_IDS" | while read id; do
                if [ -n "$id" ]; then
                  echo "ğŸš« æ’¤é”€æäº¤: $id"
                  if xcrun notarytool cancel "$id" --apple-id "$APPLE_ID" --password "$APPLE_PASSWORD" --team-id "$APPLE_TEAM_ID"; then
                    echo "âœ… æˆåŠŸæ’¤é”€: $id"
                  else
                    echo "âŒ æ’¤é”€å¤±è´¥: $id"
                  fi
                  echo "---"
                fi
              done
            fi
          fi
          
          if [ -n "$SPECIFIC_ID" ]; then
            echo ""
            echo "ğŸ¯ æ’¤é”€æŒ‡å®šçš„æäº¤: $SPECIFIC_ID"
            if xcrun notarytool cancel "$SPECIFIC_ID" --apple-id "$APPLE_ID" --password "$APPLE_PASSWORD" --team-id "$APPLE_TEAM_ID"; then
              echo "âœ… æˆåŠŸæ’¤é”€æŒ‡å®šæäº¤: $SPECIFIC_ID"
            else
              echo "âŒ æ’¤é”€æŒ‡å®šæäº¤å¤±è´¥: $SPECIFIC_ID"
            fi
          fi
          
          echo ""
          echo "ğŸ“Š æ’¤é”€åçš„çŠ¶æ€:"
          xcrun notarytool history --keychain-profile "cancel" --output-format json | jq -r '.history[0:5][] | "ğŸ”¸ ID: \(.id) | çŠ¶æ€: \(.status) | åˆ›å»ºæ—¶é—´: \(.createdDate)"'
          
          # æ¸…ç†å‡­æ®
          xcrun notarytool delete-credentials "cancel" || true
          
          echo ""
          echo "ğŸ• æ’¤é”€å®Œæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ’¡ å»ºè®®ç­‰å¾… 30-60 åˆ†é’Ÿåå†é‡æ–°æäº¤æ„å»ºï¼Œè®© Apple æœåŠ¡å™¨æ¢å¤æ­£å¸¸"
