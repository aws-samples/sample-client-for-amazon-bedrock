name: "check-notarization-status"

on:
  workflow_dispatch:

jobs:
  check-status:
    runs-on: macos-latest
    steps:
      - name: Check Notarization Status
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "ğŸ” æ£€æŸ¥å…¬è¯çŠ¶æ€..."
          
          # å­˜å‚¨å‡­æ®
          xcrun notarytool store-credentials "status-check" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$APPLE_TEAM_ID"
          
          # è·å–æœ€è¿‘çš„æäº¤å†å²
          echo "è·å–å…¬è¯å†å²..."
          xcrun notarytool history --keychain-profile "status-check" --output-format json > history.json
          
          # è§£æå¹¶æ£€æŸ¥æ¯ä¸ª In Progress çš„çŠ¶æ€
          echo "æ£€æŸ¥ In Progress çŠ¶æ€çš„æäº¤..."
          cat history.json | jq -r '.history[] | select(.status == "In Progress") | .id' | while read id; do
            echo "æ£€æŸ¥æäº¤ ID: $id"
            xcrun notarytool info "$id" --keychain-profile "status-check"
            echo "---"
          done
          
          # æ¸…ç†å‡­æ®
          xcrun notarytool delete-credentials "status-check" || true
