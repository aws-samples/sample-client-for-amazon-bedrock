name: "monitor-notarization"

on:
  workflow_dispatch:
    inputs:
      submission_id:
        description: 'Notarization Submission ID to monitor (optional)'
        required: false
        type: string

jobs:
  monitor:
    runs-on: macos-latest
    steps:
      - name: Monitor Notarization Progress
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          SUBMISSION_ID: ${{ github.event.inputs.submission_id }}
        run: |
          echo "ğŸ” å…¬è¯è¿›åº¦ç›‘æ§å¼€å§‹ - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=================================="
          
          # å­˜å‚¨å‡­æ®
          xcrun notarytool store-credentials "monitor" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$APPLE_TEAM_ID"
          
          echo "ğŸ“‹ è·å–æœ€è¿‘çš„å…¬è¯å†å²..."
          xcrun notarytool history --keychain-profile "monitor" --output-format json > history.json
          
          # æ˜¾ç¤ºæœ€è¿‘çš„æäº¤
          echo "æœ€è¿‘çš„å…¬è¯æäº¤:"
          cat history.json | jq -r '.history[0:5][] | "ğŸ”¸ ID: \(.id)\n   çŠ¶æ€: \(.status)\n   åˆ›å»ºæ—¶é—´: \(.createdDate)\n   åç§°: \(.name)\n"'
          
          # å¦‚æœæŒ‡å®šäº†ç‰¹å®šçš„æäº¤IDï¼Œç›‘æ§å®ƒ
          if [ -n "$SUBMISSION_ID" ]; then
            echo "ğŸ¯ ç›‘æ§æŒ‡å®šçš„æäº¤: $SUBMISSION_ID"
            xcrun notarytool info "$SUBMISSION_ID" --keychain-profile "monitor"
          else
            # ç›‘æ§æ‰€æœ‰ In Progress çš„æäº¤
            echo "ğŸ”„ ç›‘æ§æ‰€æœ‰è¿›è¡Œä¸­çš„æäº¤..."
            cat history.json | jq -r '.history[] | select(.status == "In Progress") | .id' | while read id; do
              echo "ğŸ“Š æ£€æŸ¥æäº¤ $id çš„è¯¦ç»†çŠ¶æ€:"
              xcrun notarytool info "$id" --keychain-profile "monitor" || echo "æ— æ³•è·å–è¯¦ç»†ä¿¡æ¯"
              echo "---"
            done
          fi
          
          # æ˜¾ç¤ºå…¬è¯æœåŠ¡çŠ¶æ€
          echo "ğŸŒ Apple å…¬è¯æœåŠ¡è¿æ¥æµ‹è¯•:"
          if xcrun notarytool history --keychain-profile "monitor" --output-format json >/dev/null 2>&1; then
            echo "âœ… å…¬è¯æœåŠ¡è¿æ¥æ­£å¸¸"
          else
            echo "âŒ å…¬è¯æœåŠ¡è¿æ¥å¼‚å¸¸"
          fi
          
          # æ¸…ç†å‡­æ®
          xcrun notarytool delete-credentials "monitor" || true
          
          echo "ğŸ• ç›‘æ§å®Œæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
