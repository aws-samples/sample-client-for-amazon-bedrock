name: "optimized-notarization"

on:
  workflow_dispatch:
    inputs:
      timeout_minutes:
        description: 'Notarization timeout in minutes'
        required: false
        default: '30'
        type: string

jobs:
  optimized-notarization:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Optimized Notarization Strategy
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          TIMEOUT_MINUTES: ${{ github.event.inputs.timeout_minutes }}
        run: |
          echo "ğŸš€ ä¼˜åŒ–çš„å…¬è¯ç­–ç•¥æµ‹è¯•"
          echo "=================================="
          echo "è¶…æ—¶è®¾ç½®: ${TIMEOUT_MINUTES} åˆ†é’Ÿ"
          echo ""
          
          # 1. æ£€æŸ¥å½“å‰é˜Ÿåˆ—çŠ¶æ€
          echo "ğŸ“Š æ£€æŸ¥å½“å‰å…¬è¯é˜Ÿåˆ—..."
          xcrun notarytool store-credentials "test" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$APPLE_TEAM_ID"
          
          # è·å–è¿›è¡Œä¸­çš„æäº¤æ•°é‡
          IN_PROGRESS_COUNT=$(xcrun notarytool history --keychain-profile "test" --output-format json | jq '.history[] | select(.status == "In Progress")' | jq -s length)
          echo "å½“å‰è¿›è¡Œä¸­çš„æäº¤æ•°é‡: $IN_PROGRESS_COUNT"
          
          if [ "$IN_PROGRESS_COUNT" -gt 5 ]; then
            echo "âš ï¸ è­¦å‘Š: é˜Ÿåˆ—ä¸­æœ‰ $IN_PROGRESS_COUNT ä¸ªè¿›è¡Œä¸­çš„æäº¤"
            echo "å»ºè®®ç­‰å¾…é˜Ÿåˆ—æ¸…ç©ºåå†æäº¤æ–°çš„å…¬è¯è¯·æ±‚"
          fi
          
          # 2. Apple å®˜æ–¹å»ºè®®çš„æœ€ä½³å®è·µ
          echo ""
          echo "ğŸ“‹ Apple å…¬è¯æœ€ä½³å®è·µ:"
          echo "1. ä½¿ç”¨ App Store Connect API å¯†é’¥è€Œä¸æ˜¯ Apple ID"
          echo "2. è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ (å»ºè®® 30-60 åˆ†é’Ÿ)"
          echo "3. é¿å…åŒæ—¶æäº¤å¤šä¸ªåº”ç”¨"
          echo "4. åœ¨éé«˜å³°æ—¶é—´æäº¤ (ç¾å›½æ—¶é—´æ·±å¤œ/æ—©æ™¨)"
          echo "5. ç›‘æ§ Apple ç³»ç»ŸçŠ¶æ€é¡µé¢"
          echo ""
          
          # 3. å»ºè®®çš„å·¥ä½œæµé…ç½®
          echo "ğŸ”§ å»ºè®®çš„ tauri-action é…ç½®:"
          echo "env:"
          echo "  # ä½¿ç”¨ API å¯†é’¥ (æ¨è)"
          echo "  APPLE_API_KEY: \${{ secrets.APPLE_API_KEY }}"
          echo "  APPLE_API_KEY_ID: \${{ secrets.APPLE_API_KEY_ID }}"
          echo "  APPLE_API_ISSUER: \${{ secrets.APPLE_API_ISSUER }}"
          echo "  # æˆ–è€…ä½¿ç”¨ Apple ID (å¤‡é€‰)"
          echo "  # APPLE_ID: \${{ secrets.APPLE_ID }}"
          echo "  # APPLE_PASSWORD: \${{ secrets.APPLE_PASSWORD }}"
          echo "  # APPLE_TEAM_ID: \${{ secrets.APPLE_TEAM_ID }}"
          echo ""
          
          # æ¸…ç†
          xcrun notarytool delete-credentials "test" || true
          
          echo "âœ… åˆ†æå®Œæˆ"
