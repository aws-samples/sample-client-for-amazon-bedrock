name: "test-macos-signing"

on: 
  workflow_dispatch: # Manual trigger only

# Test macOS code signing specifically

jobs:
  test-macos-signing:
    permissions:
      contents: write
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Install frontend dependencies
        run: yarn install

      - name: Debug Apple Certificates
        run: |
          echo "ğŸ” è°ƒè¯• Apple è¯ä¹¦é…ç½®..."
          echo "APPLE_CERTIFICATE é•¿åº¦: ${#APPLE_CERTIFICATE}"
          echo "APPLE_CERTIFICATE_PASSWORD: '$APPLE_CERTIFICATE_PASSWORD'"
          echo "APPLE_SIGNING_IDENTITY: '$APPLE_SIGNING_IDENTITY'"
          echo "APPLE_TEAM_ID: '$APPLE_TEAM_ID'"
          echo "APPLE_ID: '$APPLE_ID'"
          echo ""
          
          # æ£€æŸ¥è¯ä¹¦æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ base64
          if echo "$APPLE_CERTIFICATE" | base64 -d > /tmp/test_cert.p12 2>/dev/null; then
            echo "âœ“ è¯ä¹¦ base64 è§£ç æˆåŠŸ"
            ls -la /tmp/test_cert.p12
          else
            echo "âœ— è¯ä¹¦ base64 è§£ç å¤±è´¥"
          fi
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_ID: ${{ secrets.APPLE_ID }}

      - name: Test Certificate Import Manually
        run: |
          echo "ğŸ”§ æ‰‹åŠ¨æµ‹è¯•è¯ä¹¦å¯¼å…¥..."
          
          # åˆ›å»ºä¸´æ—¶å¯†é’¥é“¾
          KEYCHAIN_PASSWORD="temp123456"
          security create-keychain -p "$KEYCHAIN_PASSWORD" test.keychain
          security default-keychain -s test.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" test.keychain
          security set-keychain-settings -t 3600 -u test.keychain
          
          # è§£ç è¯ä¹¦
          echo "$APPLE_CERTIFICATE" | base64 -d > certificate.p12
          
          # å°è¯•å¯¼å…¥è¯ä¹¦
          echo "å°è¯•å¯¼å…¥è¯ä¹¦..."
          if security import certificate.p12 -k test.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign; then
            echo "âœ“ è¯ä¹¦å¯¼å…¥æˆåŠŸ"
            
            # åˆ—å‡ºå¯ç”¨çš„ç­¾åèº«ä»½
            echo "å¯ç”¨çš„ç­¾åèº«ä»½:"
            security find-identity -v test.keychain
            
            # è®¾ç½®å¯†é’¥é“¾åˆ†åŒºåˆ—è¡¨
            security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" test.keychain
            
          else
            echo "âœ— è¯ä¹¦å¯¼å…¥å¤±è´¥"
            exit 1
          fi
          
          # æ¸…ç†
          rm certificate.p12
          security delete-keychain test.keychain
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Build macOS app with signing (ARM64 only)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENABLE_CODE_SIGNING: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          # ä¸åˆ›å»º releaseï¼Œåªæ„å»º
          tagName: ""
          releaseName: ""
          releaseBody: ""
          releaseDraft: false
          prerelease: false
          args: --target aarch64-apple-darwin

      - name: Verify build output
        run: |
          echo "ğŸ” æ£€æŸ¥æ„å»ºè¾“å‡º..."
          find src-tauri/target -name "*.app" -o -name "*.dmg" | head -10
          
          # éªŒè¯ç­¾å
          if find src-tauri/target -name "*.app" | head -1 | xargs -I{} codesign -dv --verbose=4 {}; then
            echo "âœ“ åº”ç”¨ç­¾åéªŒè¯æˆåŠŸ"
          else
            echo "âœ— åº”ç”¨ç­¾åéªŒè¯å¤±è´¥"
          fi

      - name: Upload signed app
        uses: actions/upload-artifact@v4
        with:
          name: signed-macos-app-arm64
          path: |
            src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app
            src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
          retention-days: 7
          if-no-files-found: warn
